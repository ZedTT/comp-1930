<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <script src="https://www.gstatic.com/firebasejs/5.8.5/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = { //hello
            apiKey: "AIzaSyBwSxJojnYNo9ZFKHmO59sKVPdEhCR641A",
            authDomain: "comp1930database.firebaseapp.com",
            databaseURL: "https://comp1930database.firebaseio.com",
            projectId: "comp1930database",
            storageBucket: "comp1930database.appspot.com",
            messagingSenderId: "908131063499"
        };
        firebase.initializeApp(config);
    </script>
    <style>
        .toyListing {
            border: 2px solid black;
            border-radius: 10px;
            width: 50%;
            text-align: center;
            font-size: 20pt;
            margin: 2rem;
        }

        .toyListing span {
            text-decoration: underline;
        }

        .listingTitle {
            background-color: #eee;
        }

        .listingPrice span {
            font-size: 7pt;
        }

        .listingAgeRange span {
            font-size: 7pt;
            text-decoration: none;

        }
    </style>
</head>

<body>
    <div id="listingsContainer"></div>
    <script>
        // usage: elm("div", document.body, "myID", "myClass");
        function elm(tag, parent, id, cssClass) {
            var thisElm = document.createElement(tag);
            if (id) {
                thisElm.setAttribute("id", id)
            };
            if (cssClass) {
                thisElm.setAttribute("class", cssClass)
            };
            parent.appendChild(thisElm);
            return thisElm
        };

        // Adds style to an element
        function addStyle(element, property, value) {
            var currentStyle = element.getAttribute("style");
            if (!currentStyle) {
                currentStyle = ""
            }
            element.setAttribute("style", currentStyle + " " + property + ": " + value + ";");
        };

        // Adds style to an element. styleArray must have an even number of indexes.
        function addArrayOfStyles(element, styleArray) {
            var currentStyle = element.getAttribute("style");
            if (!currentStyle) {
                currentStyle = ""
            }
            for (i = 0; i < styleArray.length; i++) {
                element.setAttribute("style", currentStyle + " " + styleArray[i] + ": " + styleArray[++i] + ";");
                currentStyle = element.getAttribute("style");
            };
        };


        // Adds style to all elements in an array
        function addStyleToArray(arrayOfElements, property, value) {
            for (let i = 0; i < arrayOfElements.length; i++) {
                addStyle(arrayOfElements[i], property, value);
            };
        };

        // Adds style to all elements of a class
        function addStyleByClass(cssClass, property, value) {
            let cssClassArray = document.getElementsByClassName(cssClass);

            addStyleToArray(cssClassArray, property, value);
        };

        function elmStyle(tag, parent, styleArray, id, cssClass) {
            var thisElm = elm(tag, parent, id, cssClass);
            addArrayOfStyles(thisElm, styleArray);
            return thisElm;
        };

        var body = document.body
    </script>
    <script>
        var listings = document.getElementsByClassName("toyListing");
        var listingsContainer = document.getElementById("listingsContainer");

        var ageMinValue;
        var ageMaxValue;

        function updateListing(ToyName, listingNumber) {
            var thisListing = elm("div", listingsContainer, "", "toyListing");

            var title = elm("div", thisListing, "", "listingTitle");
            var price = elm("div", thisListing, "", "listingPrice");
            var ageRange = elm("div", thisListing, "", "listingAgeRange");

            var toys = firebase.database().ref().child("Toys");
            var thisToy = toys.child(ToyName);

            var nameRef = thisToy.child("Name");
            nameRef.on('value', function (snap) {
                // console.log(snap.val());
                var val = ""
                if (snap.val()) {
                    val = "Listing: " + snap.val();
                } else {
                    val = ToyName
                    console.log("Name missing for " + ToyName);
                }
                title.innerHTML = val;
            });
            var priceRef = thisToy.child("Price");
            priceRef.on('value', function (snap) {
                // console.log(snap.val());
                var val = "Price not available";
                if (snap.val()) {
                    val = "Price: $" + snap.val();
                }
                price.innerHTML = val;
            });
            ageMinRef = thisToy.child("Age_Min");
            console.log(ageMinRef);
            ageMinRef.on('value', function (snap) {
                // console.log(snap.val());
                var val = "";
                if (snap.val()) {
                    val = snap.val()
                }
                ageMinValue = val;
                return ageMinValue;

            });


            ageMaxRef = thisToy.child("Age_Max");
            ageMaxRef.on('value', function (snap) {
                // console.log(snap.val());
                var val = "";
                if (snap.val()) {
                    val = snap.val()
                }
                ageMaxValue = val;
                console.log(ageMaxValue);
            });
            console.log(ageMaxValue);
            if (ageMinValue != null && ageMaxValue != null) {
                ageRange.innerHTML = "Age Range: " + ageMinValue + "-" + ageMaxValue;
            } else {
                ageRange.innerHTML = "Age range not available";
            }
            ageRange.innerHTML = "Age Range: " + ageMinValue + "-" + ageMaxValue;
        };

        // function filterPrice(min, max) {
        //         dbRef = firebase.database().ref().child("Toys");
        //         dbRef.on('value', function (snap) {
        //             listingsContainer.innerHTML = "";
        //             snap.forEach(function(snap){
        //                 price = snap.child("Price").val();
        //                 if (price >= min && price <= max) {
        //                     let i = 0
        //                     updateListing(snap.key, i)
        //                     i++;
        //                 }
        //             });
        //     });
        // };

        // filterPrice(10, 49);

        // function filterPlus(minPrice, maxPrice, age) {
        //     dbRef = firebase.database().ref().child("Toys");
        //     dbRef.once('value', function (snap) {
        //         listingsContainer.innerHTML = "";
        //         snap.forEach(function (snap) {
        //             let i = 0
        //             price = snap.child("Price").val();
        //             ageMax = snap.child("Age_Max").val();
        //             ageMin = snap.child("Age_Min").val();
        //             if (price >= minPrice && price <= maxPrice) {
        //                 if (age) {
        //                     if (age >= ageMin && age <= ageMax) {
        //                         updateListing(snap.key, i++);
        //                     } else {
        //                         console.log("nope " + ageMin + " " + ageMax)
        //                     }
        //                 } else {
        //                     updateListing(snap.key, i++);
        //                 }
        //             } else {
        //                 console.log("rejected on price")
        //             }
        //         });
        //     });
        // };
        // filterPlus(0, 100);

        // function getToyArray() {
        //     var thisToy = []
        //     var theseToys = []

        //     dbRef = firebase.database().ref().child("Toys");
        //     dbRef.once('value', function (snap) {
        //         snap.forEach(function (snap) {
        //             let i = 0
        //             title = snap.key;
        //             price = snap.child("Price").val();
        //             ageMax = snap.child("Age_Max").val();
        //             ageMin = snap.child("Age_Min").val();

        //             thisToy = [title, price, ageMax, ageMin];

        //             theseToys.push(thisToy);

        //             // console.log(theseToys);
        //         });
        //     })
        //     return theseToys;
        // };
        // var toyArray = getToyArray();

        // function filterByMaxPrice(arrayOfToys, min, max) {
        //     console.log(arrayOfToys);
        //     for (i = 0; i < arrayOfToys.length; i++) {
        //         console.log(arrayOfToys);
        //         thisToy = arrayOfToys[x];
        //         price = thisToy[1];
        //         if (price >= min && price <= max) {
        //             let i = 0
        //             console.log("pass");
        //             i++;
        //         }
        //     }
        // }

        // filterByMaxPrice(toyArray, 0, 1000);

        // console.log(toyArray == [["Cars_Speedy_Gonzales", 21, 14, 6], ["Harry_Potter", 45, 15, 8], ["Hasbro_Big_Fish_In_A_Pong", 20, 10, 4], ["Miniso_Piano", 15, 13, 4], ["NBA_Figure_Set", 50, 15, 5], ["Transformers", 40, 16, 7]]);

        function filterPlus(minPrice, maxPrice, age) {
            dbRef = firebase.database().ref().child("Toys");
            dbRef.once('value', function (snap) {
                listingsContainer.innerHTML = "";
                snap.forEach(function (snap) {
                    let i = 0
                    price = snap.child("Price").val();
                    ageMax = snap.child("Age_Max").val();
                    ageMin = snap.child("Age_Min").val();
                    if (price < minPrice || price > maxPrice) {
                    return;
                    }
                    if (age < ageMin || age > ageMax) { 
                    return;
                    }
                    updateListing(snap.key, i++);
                });
            });
        };
        filterPlus(0, 100);
    </script>
</body>

</html>