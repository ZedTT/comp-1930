<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    
    <script src="https://www.gstatic.com/firebasejs/5.8.5/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = { //hello
            apiKey: "AIzaSyBwSxJojnYNo9ZFKHmO59sKVPdEhCR641A",
            authDomain: "comp1930database.firebaseapp.com",
            databaseURL: "https://comp1930database.firebaseio.com",
            projectId: "comp1930database",
            storageBucket: "comp1930database.appspot.com",
            messagingSenderId: "908131063499"
        };
        firebase.initializeApp(config);
    </script>
    <link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah" rel="stylesheet">
    <style>

        body {
            background-color: royalblue;
        }
      
        .toyListing {
            border: 3px solid black;
            border-radius: 10px;
            width: 50%;
            text-align: center;
            font-size: 17pt;
            margin-top: 1rem;
            margin-bottom: 1rem;
            margin-left: 22rem;
            background-color: whitesmoke;
            font-family: arial;
        }

        .toyListing span {
            text-decoration: underline;
        }

        .listingTitle {
            background-color: lightgrey;
        }

        .listingPrice span {
            font-size: 7pt;
        }

        .listingAgeRange span {
            font-size: 7pt;
            text-decoration: none;
        }

        .searchFilter {
            width: 250px;
            height: 350px;
            border: 3px solid black;
            border-radius: 5px;
            font-size: 12pt;
            background-color: lightgrey;
            margin-top: -617px;
            padding: 10px;
            font-family: arial;
        }
      
        .header {
            width: 101%;
            height: 300px;
            padding-bottom: 30px;
            margin-top: -10px;
            margin-left: -7px;
        }
        
        .header img {
            width: 100%;
            height: 300px;
        }
      
        .header p {
            text-align: center;
            font-family: 'Gloria Hallelujah', cursive;
            text-shadow: 3px 3px white;
            font-size: 70pt;
            margin-top: -340px;
            color: darkblue;
        }

    </style>
</head>

<body>
    <div class="header">
      <img src="https://www.firstsmilesdental.com/wp-content/uploads/2018/03/Kids-on-Grass-Smiling-Banner.jpg">
      <p>ToyShare</p>
    </div>
    <div id="listingsContainer"></div>
    <script>
        // usage: elm("div", document.body, "myID", "myClass");
        function elm(tag, parent, id, cssClass) {
            var thisElm = document.createElement(tag);
            if(id) {thisElm.setAttribute("id", id)};
            if(cssClass) {thisElm.setAttribute("class", cssClass)};
            parent.appendChild(thisElm);
            return thisElm
        };

        // Adds style to an element
        function addStyle(element, property, value) {
            var currentStyle = element.getAttribute("style");
            if (!currentStyle) {
                currentStyle = ""
            }
            element.setAttribute("style", currentStyle + " " + property + ": " + value + ";");
        };

        // Adds style to an element. styleArray must have an even number of indexes.
        function addArrayOfStyles(element, styleArray) {
            var currentStyle = element.getAttribute("style");
            if (!currentStyle) {
                currentStyle = ""
            }
            for(i=0;i<styleArray.length;i++) {
                element.setAttribute("style", currentStyle + " " + styleArray[i] + ": " + styleArray[++i] + ";");
                currentStyle = element.getAttribute("style");
            };
        };


        // Adds style to all elements in an array
        function addStyleToArray(arrayOfElements, property, value) {
            for (let i = 0; i < arrayOfElements.length; i++) {
                addStyle(arrayOfElements[i], property, value);
            };
        };

        // Adds style to all elements of a class
        function addStyleByClass(cssClass, property, value) {
            let cssClassArray = document.getElementsByClassName(cssClass);

            addStyleToArray(cssClassArray, property, value);
        };

        function elmStyle(tag, parent, styleArray, id, cssClass) {
            var thisElm = elm(tag, parent, id, cssClass);
            addArrayOfStyles(thisElm, styleArray);
            return thisElm;
        };

        var body = document.body
    </script>
    <script>
        var listings = document.getElementsByClassName("toyListing");
        var listingsContainer = document.getElementById("listingsContainer");

        function updateListing(ToyName, listingNumber) {
            var thisListing = elm("div", listingsContainer, "", "toyListing");

            var title = elm("div", thisListing, "", "listingTitle");
            var price = elm("div", thisListing, "", "listingPrice");
            var ageRange = elm("div", thisListing, "", "listingAgeRange");

            var toys = firebase.database().ref().child("Toys");
            var thisToy = toys.child(ToyName);
            var ageMinValue, ageMaxValue;

            var nameRef = thisToy.child("Name");
            nameRef.on('value', function (snap) {
                // console.log(snap.val());
                var val = ""
                if (snap.val()){
                    val = "Listing: " + snap.val();
                } else {
                    val = ToyName
                    console.log("Name missing for " + ToyName);
                }
                title.innerHTML = val;
            });
            var priceRef = thisToy.child("Price");
            priceRef.on('value', function (snap) {
                // console.log(snap.val());
                var val = "Price not available";
                if (snap.val()){val = "Price: $" + snap.val();}
                price.innerHTML = val;
            });
            ageMinRef = thisToy.child("Age_Min");
            ageMinRef.on('value', function (snap) {
                // console.log(snap.val());
                var val = "";
                if (snap.val()){val = snap.val()}
                ageMinValue = val;
            });
            ageMaxRef = thisToy.child("Age_Max");
            ageMaxRef.on('value', function (snap) {
                // console.log(snap.val());
                var val = "";
                if (snap.val()){val = snap.val()}
                ageMaxValue = val;
            });

            if (ageMinValue && ageMaxValue) {
                ageRange.innerHTML = "Age Range: " + ageMinValue + "-" + ageMaxValue;
            } else {ageRange.innerHTML = "Age range not available";}

        };

        // function filterPrice(min, max) {
        //         dbRef = firebase.database().ref().child("Toys");
        //         dbRef.on('value', function (snap) {
        //             listingsContainer.innerHTML = "";
        //             snap.forEach(function(snap){
        //                 price = snap.child("Price").val();
        //                 if (price >= min && price <= max) {
        //                     let i = 0
        //                     updateListing(snap.key, i)
        //                     i++;
        //                 }
        //             });
        //     });
        // };

        // filterPrice(10, 49);

        function filterPlus(minPrice, maxPrice, age) {
                dbRef = firebase.database().ref().child("Toys");
                dbRef.on('value', function (snap) {
                    listingsContainer.innerHTML = "";
                    snap.forEach(function(snap){
                        price = snap.child("Price").val();
                        ageMax = snap.child("Age_Max").val();
                        ageMin = snap.child("Age_Min").val();
                        if (price >= minPrice && price <= maxPrice) {
                            let i = 0
                            if (age) {
                                if (age >= ageMin && age <= ageMax) {
                                    let j = 0
                                    updateListing(snap.key, i);
                                    j++;
                                } else {console.log("nope " + ageMin + " " + ageMax)}
                                i++;
                            } else {updateListing(snap.key, i);}
                        } else {console.log("rejected on price")}
                    });
            });
        };

        filterPlus(0, 100);

    </script>
    
    <div class="searchFilter">
      <p><h3>Search Filters</h3>
      Name of toy:<br/>
      <input type="text" name="Name" placeholder="Name" pattern="[A-Za-z1-9]"/><br/><br/>
      Price:<br/>
      <input type="text" name="Price" placeholder="Amount" pattern="[1-9]"/><br/><br/>
      Mininum Age:<br/>
      <input type="number" name="Age Min" placeholder="Min Age" min="0" max="100"/><br/><br/>
      Maximum Age:<br/>
      <input type="number" name="Age Max" placeholder="Max Age" min="0" max="100"/><br/><br/><br/>
      <input type="submit" name="Submit" value="Search"/>
      </p>
    </div>
    
</body>

</html>