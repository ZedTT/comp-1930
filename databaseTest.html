<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <!-- Links for JQuery-->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css" type="text/css"
        media="all" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript"></script> -->

    <link rel="stylesheet" href="css/asRange.css">
    <script src="JQuery.js"></script>
    <script src="jquery-asRange.js"></script>

    <script src="https://www.gstatic.com/firebasejs/5.8.5/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = { //hello
            apiKey: "AIzaSyBwSxJojnYNo9ZFKHmO59sKVPdEhCR641A",
            authDomain: "comp1930database.firebaseapp.com",
            databaseURL: "https://comp1930database.firebaseio.com",
            projectId: "comp1930database",
            storageBucket: "comp1930database.appspot.com",
            messagingSenderId: "908131063499"
        };
        firebase.initializeApp(config);
    </script>
    <link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah" rel="stylesheet">
    <style>

        body {
            /* background-image: url("https://d1q8kgt00fn2v8.cloudfront.net/files/uploads/2018/03/kids_playing_with-_blocks-1600x1067.jpg"); */
            /* background-repeat: no-repeat; */
            /* background-size: cover; */
            margin: 0px;
            padding: 0px;
            grid-template-rows: /* 40px */ 80px auto;
            display: grid;
            grid-template-areas: 
                /* "h1" */
                "h2"
                "content";
        }

        .header1 {
            grid-area: h1;
            width: 100%;
            background-color: #991c1c;
        }
        
        .header2 {
            grid-area: h2;
            width: 100%;
            background-color: crimson;
        }

        .header2 p {
            font-family: 'Gloria Hallelujah', cursive;
            text-shadow: 3px 3px black;
            font-size: 30pt;
            color: white;
            margin: 0;
            margin-left: 1em;
            line-height: calc(80px - 10px);
        }

        #content {
            grid-area: content;
            grid-template-rows: 200px auto;
            grid-template-columns: 300px auto;
            display: grid;
            grid-template-areas: 
                "search search"
                "sideBar listings";
        }

        .searchBar {
            grid-area: search;
            width: 500px;
            height: 30px;
            background-color: whitesmoke;
            border: 3px solid black;
            border-radius: 30px;
            margin:  auto auto auto auto;
            text-align: center;
            font-family: arial;
            padding-top: 13px;
            color: grey;
            font-size: 18pt;
            padding: 25px;
        }

        #filtersContainer {
            grid-area: sideBar;
        }

        #filters {
            border: 3px solid crimson;
            border-radius: 5px;
            font-size: 12pt;
            background-color: whitesmoke;
            padding: 10px;
            margin-left: 15px;
            font-family: arial;
        }

        .filter {
            margin: 1.5rem 0.75rem;
        }

        .sliderTitle {
            margin-bottom: 3rem;
        }

        .asRange {
            width: 100%;
        }

        #listingsContainer {
            grid-area: listings;
        }

        .toyListing {
            border: 3px solid crimson;
            border-radius: 10px;
            text-align: center;
            font-size: 17pt;
            width: 80%;
            margin: auto;
            margin-bottom: 1rem;
            background-color: whitesmoke;
            font-family: arial;
        }

        .toyListing span {
            text-decoration: underline;
        }

        .listingTitle {
            background-color: crimson;
        }

        .listingPrice span {
            font-size: 7pt;
        }

        .listingAgeRange span {
            font-size: 7pt;
            text-decoration: none;
        }

    </style>
</head>

<body>
    <!-- <div class="header1"></div> -->
    <div class="header2">
        <p>ToyShare</p>
    </div>
    <div id="content">
        <input class="searchBar" type="search" placeholder="Search for toys...." />
        <div id="listingsContainer"></div>
        <div id="filtersContainer">
            <div id="filters">
                <h3>Filters</h3>
                <!-- <div class="filter">
                    <div class="filterTitle">Name of toy:</div>
                    <input type="text" name="Name" placeholder="Name" pattern="[A-Za-z1-9]" />
                </div> -->
                <div class="filter">
                    <div class="filterTitle sliderTitle">Price:</div>
                    <input class="priceSlider slider" type="range" min="0" max="100" name="price" step="1" />
                </div>
                <div class="filter">
                    <div class="filterTitle sliderTitle">Age</div>
                    <input class="ageSlider slider" type="range" min="0" max="20" name="age" step="1" onchange="console.log('test')" />
                </div>
            </div>
        </div>
    </div>

    <script>
        // usage: elm("div", document.body, "myID", "myClass");
        function elm(tag, parent, id, cssClass) {
            var thisElm = document.createElement(tag);
            if (id) {
                thisElm.setAttribute("id", id);
            };
            if (cssClass) {
                thisElm.setAttribute("class", cssClass);
            };
            parent.appendChild(thisElm);
            return thisElm
        };

        // Adds style to an element
        function addStyle(element, property, value) {
            var currentStyle = element.getAttribute("style");
            if (!currentStyle) {
                currentStyle = ""
            }
            element.setAttribute("style", currentStyle + " " + property + ": " + value + ";");
        };

        // Adds style to an element. styleArray must have an even number of indexes.
        function addArrayOfStyles(element, styleArray) {
            var currentStyle = element.getAttribute("style");
            if (!currentStyle) {
                currentStyle = ""
            }
            for (i = 0; i < styleArray.length; i++) {
                element.setAttribute("style", currentStyle + " " + styleArray[i] + ": " + styleArray[++i] + ";");
                currentStyle = element.getAttribute("style");
            };
        };

        // Adds style to all elements in an array
        function addStyleToArray(arrayOfElements, property, value) {
            for (let i = 0; i < arrayOfElements.length; i++) {
                addStyle(arrayOfElements[i], property, value);
            };
        };

        // Adds style to all elements of a class
        function addStyleByClass(cssClass, property, value) {
            let cssClassArray = document.getElementsByClassName(cssClass);

            addStyleToArray(cssClassArray, property, value);
        };

        function elmStyle(tag, parent, styleArray, id, cssClass) {
            var thisElm = elm(tag, parent, id, cssClass);
            addArrayOfStyles(thisElm, styleArray);
            return thisElm;
        };

        var body = document.body
    </script>
    <script>
        // An array of all the listings on the page
        var listings = document.getElementsByClassName("toyListing");
        // A locator for the container that holds the listings
        var listingsContainer = document.getElementById("listingsContainer");

        // this function adds a single listing to the page
        // the parameter snap is a snaphot of the database
        // the snap in this case actually only contains a snapshot of a SINGLE toy
        // this function is called by the filter function
        function createListing(snap) {

            // Create the html that will contain out listing and all it's information
            var thisListing = elm("div", listingsContainer, "", "toyListing");
            var title = elm("div", thisListing, "", "listingTitle");
            var price = elm("div", thisListing, "", "listingPrice");
            var ageRange = elm("div", thisListing, "", "listingAgeRange");

            // The key of the toy, used only as a back up if the name field is missing
            var thisToy = snap.key;
            // Grabbbing values from the snap
            var nameVal = snap.child("Name").val();
            var priceVal = snap.child("Price").val();
            var ageMaxVal = snap.child("Age_Max").val();
            var ageMinVal = snap.child("Age_Min").val();

            // check that each value exists before adding it
            // if the value is null, display an error instead
            if (nameVal) {
                title.innerText = "Listing: " + nameVal
            } else {
                title.innerText = "Error: " + thisToy
            }

            if (priceVal || priceVal == 0) {
                price.innerText = "Price: $" + priceVal
            } else {
                price.innerText = "Error: no pricing data"
            }

            if (!!ageMinVal.toString() && !!ageMaxVal.toString()) {
                ageRange.innerHTML = "Age Range: " + ageMinVal + "-" + ageMaxVal;
            } else {
                ageRange.innerHTML = "Age range not available";
            }
        };

        // this is the function that filters the page
        function filterPlus(minPrice, maxPrice, age) {
            // this is the reference to our database, specifically the toys
            dbRef = firebase.database().ref().child("Toys");
            // this function runs every time the database has a change
            dbRef.on('value', function (snapshot) {
                // IMPORTANT: clear the old listings before adding updated ones 
                listingsContainer.innerHTML = "";
                // a loop for each toy
                snapshot.forEach(function (snap) {
                    // grabbing values from the database
                    priceVal = snap.child("Price").val();
                    ageMaxVal = snap.child("Age_Max").val();
                    ageMinVal = snap.child("Age_Min").val();
                    // the actual filters, if any of these pass, it means the filter failed, return ends the loop
                    if (priceVal < minPrice || priceVal > maxPrice) {
                        return;
                    }
                    if (age < ageMinVal || age > ageMaxVal) {
                        return;
                    }
                    // Calls the create listing function with a single toys data. We only get to this point if both filters pass
                    createListing(snap);
                });
            });
        };
        filterPlus(0, 100);

        jQuery(function ($) {
            $('.priceSlider').asRange({
                range: true,
                value: [0, 100],
                format(value) {
                    return "$" + value;
                }
            });
        });

        jQuery(function ($) {
            $('.ageSlider').asRange({
                range: true,
                value: [0, 20],
                format(value) {
                    return value;
                }
            });
        });
    </script>

    <script>
        // For testing offline only
        if (!navigator.onLine) {    
            for (i=0;i<5;i++) {
                var thisListing = elm("div", listingsContainer, "", "toyListing");
                var title = elm("div", thisListing, "", "listingTitle");
                title.innerHTML = "You are offline";
                var price = elm("div", thisListing, "", "listingPrice");
                price.innerHTML = "Price: cannot connect";
                var ageRange = elm("div", thisListing, "", "listingAgeRange");
                ageRange.innerHTML = "Age Range: to-firebase";
            }            
        }
    </script>

</body>

</html>