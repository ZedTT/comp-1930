<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ToyShare: Canada's No.1 Toy Donation/Sell Center</title>

    <!-- Links for JQuery-->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css" type="text/css"
        media="all" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript"></script> -->

    <link rel="stylesheet" href="css/asRange.css">
    <script src="JQuery.js"></script>
    <script src="jquery-asRange.js"></script>

    <script src="https://www.gstatic.com/firebasejs/5.8.5/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = { //hello
            apiKey: "AIzaSyBwSxJojnYNo9ZFKHmO59sKVPdEhCR641A",
            authDomain: "comp1930database.firebaseapp.com",
            databaseURL: "https://comp1930database.firebaseio.com",
            projectId: "comp1930database",
            storageBucket: "comp1930database.appspot.com",
            messagingSenderId: "908131063499"
        };
        firebase.initializeApp(config);
    </script>
    <link href="https://fonts.googleapis.com/css?family=Gloria+Hallelujah" rel="stylesheet">
    <style>

        /*
         * #fbf5f3
         * #93e1d8
         * #e28413
         * #db3a34
         * #000022 
         */

        .color-white-0 { color: #FBF5F3 }
        .color-white-1 { color: #9C8881 }
        .color-white-2 { color: #C0B3AE }
        .color-white-3 { color: #FFFFFF }
        .color-white-4 { color: #FFFFFF }

        .color-blue-0 { color: #93E1D9 }
        .color-blue-1 { color: #F3FEFD }
        .color-blue-2 { color: #C4F4EF }
        .color-blue-3 { color: #66C6BC }
        .color-blue-4 { color: #3EA197 }

        .color-orange-0 { color: #E28313 }
        .color-orange-1 { color: #FFBC6D }
        .color-orange-2 { color: #F1A142 }
        .color-orange-3 { color: #B36407 }
        .color-orange-4 { color: #8C4C00 }

        .color-red-0 { color: #DB3834 }
        .color-red-1 { color: #FF8B88 }
        .color-red-2 { color: #F15E5A }
        .color-red-3 { color: #B71B17 }
        .color-red-4 { color: #900603 }

        .color-black-0 { color: #000022 }
        
        #colors {
            color: #fbf5f3; /* background */
            color: #93e1d8; /* */
            color: #e28413; /* */
            color: #db3a34; /* */
            color: #000022; /* */

            color: #F4EFED; /* background white darker */
        }


        body {
            /* background-image: url("https://d1q8kgt00fn2v8.cloudfront.net/files/uploads/2018/03/kids_playing_with-_blocks-1600x1067.jpg"); */
            /* background-repeat: no-repeat; */
            /* background-size: cover; */
            margin: 0px;
            padding: 0px;
            /* grid-template-rows: 55px auto;
            display: grid;
            grid-template-areas: 
                "h2"
                "content"; */
            background-color: #e7e7e7
        }
        
        .header2 {
            width: 100%;
            background-color: #ffffff;
            display: grid;
            grid-template-rows: 55px;
            grid-template-columns: min-content minmax(auto, 400px) min-content;
            justify-content: space-between;
            grid-template-areas: 
                "left middle right";
            position: fixed;
            z-index: 1;
        }

        #left {
            max-width: 250px;
            width: min-content;
        }

        .header2 p {
            font-family: 'Gloria Hallelujah', cursive;
            font-size: 25pt;
            color: #991c1c;
            margin-left: 1em;
            margin-right: 1em; /*added right margin for when things get close */
            line-height: 55px;
            margin-top: -3px;
            font-weight: bolder;
            vertical-align: middle;
        }

        #content {
            display: grid;
            transform: translate(0px, 55px);
            padding-top: 40px;
            justify-content: space-around;
            justify-items: center;
            grid-template-columns: 20% 50% 20%;
            grid-template-areas: 
                "sideBar listings ads";
        }

        /* causes ads to disapear on small screens */
        @media only screen and (max-width: 1000px) {
            #content {
                grid-template-columns: 20% 70%;
            }
            #ads {
                display: none;
            }
        }

        /* causes profile Image to disapear on small screens */
        @media only screen and (max-width: 1000px) {
           #right {
               margin-left: -30px;
           }
        }   

        /**#searchContainer {
            grid-area: searchBar;
            width: 100%;
            text-align: center;
            background-color: crimson;
        }*/

        .searchBar {
            grid-area: middle;
            width: 100%; /* Width will fill the grid area if less than max width */
            max-width: 400px; /* The 400 needs to be max-width or we get horizontal scrolling */ /* not neccessary at all because grid-template-columns of parent limits this to 400px now, anyways */
            height: 13px;
            background-color: #f7f7f7;
            border: 1px solid #cfcfcf;
            border-radius: 3px;
            margin: auto auto auto auto;
            text-align: center;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-weight: 100;
            color: black;
            font-size: 10pt;
            padding: 18px;
            text-align: left;
        }

        #right {
            max-width: 250px;
            width: min-content;
            grid-area: right;
            height: 100%;
            display: grid; /* vertical align */
            grid-template-columns: repeat(2, auto);
            justify-self: center; /* could be end */
        }

        .favouritesButton {
            /* grid-area: right; */ /* added to parent */
            width: 70px;
            height: 20px;
            border-radius: 10px;
            background-color: #212aa5;
            border: 1px solid #212aa5;
            color: #fbf5f3;
            text-align: center;
            /* vertical-align: middle; */ /* no longer needed */
            line-height: 20px;
            font-family: Arial;
            font-weight: bold;
            margin: auto 1em; /* added minimum left and right margin */
            font-size: 10pt;
            margin-left: 60px;
        }

        #filtersContainer {
            grid-area: sideBar;
            /* position: fixed; */
        }

        #filters {
            /* width: 20vw; */
            border-radius: 3px;
            font-size: 12pt;
            background-color: #ffffff;
            padding: 10px;
            font-family: arial;
            border: 1px solid #dad9d9;
        }

        .filter {
            margin: 1.5rem 0.75rem;
        }

        .sliderTitle {
            margin-bottom: 3rem;
        }

        .asRange {
            width: 100%;
        }

        #listingsContainer {
            grid-area: listings;
            /* overflow-y: auto; */
            height: calc(100vh - 95px);
            width: 100%;
        }

        .toyListing {
            border: 1px solid #dad9d9;
            border-radius: 3px;
            font-size: 10pt;
            width: calc(100% - 30px); /* 100% minus any padding */
            margin: auto;
            margin-bottom: 2rem;
            background-color: #ffffff;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            padding: 10px; /* If padding is changed width must be changed */
            padding-left: 20px;
        }

        .toyListing img{ 
            width: 75%;
            height: 50%;
            margin-top: 10px;
        }

        .toyListing span {
            text-decoration: underline;
        }

        .listingTitle {
            background-color: #f1f1f1;
            border: 1px solid #f1f1f1;
            border-radius: 5px;
            padding-left: 8px;
            margin-bottom: 18px;
            margin-left: -8px;
            width: 100%;
            font-weight:500;
            font-size: 13pt ;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
        }

        .listingPrice span {
            font-size: 7pt;
        }

        .listingAgeRange span {
            font-size: 7pt;
            text-decoration: none;
        }

        #ads {
            grid-area: ads;
            justify-content: center;
        }

        .wasteInfo {
            width: 90%;
            border: 1px solid black;
            border-radius: 3px;
            background-color: yellow;
            text-align: center;
            font-size: 20pt;
            font-weight: bold;
            margin: 0 auto;
        }

        .wasteInfo img {
            width: 100%;
            height: auto;
        }

        .learnMore {
            width: calc(90% - 20px);
            height: 125px;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            background-color: #991c1c;
            border: 5px solid #991c1c;
            border-radius: 5px;
            margin: 40px auto;
            font-size: 15pt;
            color: white;
            font-family: Arial;
        }

        .learnMoreButton {
            width: 120px;
            height: 30px;
            border: 3px solid white;
            border-radius: 50px;
            margin: 0 auto;
            font-size: 13pt;
            vertical-align: middle;
            line-height: 30px;
            margin-top: 20px;
        }
         
         img#profileSetting{
            text-align: center;
            margin-top: 14px;
            margin-right: 9.5px;
            width: 28px;
            height: 28px;
            padding: 0;
        }
    </style>
</head>

<body>
    <!--<div class="header1"></div>-->
    <div class="header2">
        <div id="left"><p>Toyshare</p></div>
        <input class="searchBar" type="search" placeholder="Search for toys...." />
        <div id="right">
            <div class="favouritesButton">Saved</div>
            <div class="profileButton"><img src = "http://www.sclance.com/pngs/person-icon-png/person_icon_png_1008739.png" alt="profileSetting" id="profileSetting"></div>
        </div>
    </div>
    <div id="content">
        <div id="listingsContainer"></div>
        <div id="filtersContainer">
            <div id="filters">
                <h3>Filters</h3>
                <!-- <div class="filter">
                    <div class="filterTitle">Name of toy:</div>
                    <input type="text" name="Name" placeholder="Name" pattern="[A-Za-z1-9]" />
                </div> -->
                <div class="filter">
                    <div class="filterTitle sliderTitle">Price:</div>
                    <input class="priceSlider slider" type="range" min="0" max="100" name="price" step="1" />
                </div>
                <div class="filter">
                    <div class="filterTitle sliderTitle">Age:</div>
                    <input class="ageSlider slider" type="range" min="0" max="20" name="age" step="1" />
                </div>
                <div>sliders coutesy of <a href="https://github.com/thecreation/jquery-asRange">github.com/thecreation/</a></div>
            </div>
        </div>
        <div id="ads">
            <div class="wasteInfo">
                <img src="https://hips.hearstapps.com/hmg-prod.s3.amazonaws.com/images/a-mountain-of-plastic-goods-at-a-recycling-high-res-stock-photography-678799848-1529691762.jpg" alt="Toy Wasteland">
                <p>90% of all toys on the market are made of plastic, and none of it is being recycled.<br><br>Donate today.</p>
            </div>
            <div class="learnMore">Learn more on how to donate at your local ToyShare.
                <div class="learnMoreButton">Learn More</div>
            </div>
        </div>
    </div>

    <script>
        // usage: elm("div", document.body, "myID", "myClass");
        function elm(tag, parent, id, cssClass) {
            var thisElm = document.createElement(tag);
            if (id) {
                thisElm.setAttribute("id", id);
            };
            if (cssClass) {
                thisElm.setAttribute("class", cssClass);
            };
            parent.appendChild(thisElm);
            return thisElm
        };

        // Adds style to an element
        function addStyle(element, property, value) {
            var currentStyle = element.getAttribute("style");
            if (!currentStyle) {
                currentStyle = ""
            }
            element.setAttribute("style", currentStyle + " " + property + ": " + value + ";");
        };

        // Adds style to an element. styleArray must have an even number of indexes.
        function addArrayOfStyles(element, styleArray) {
            var currentStyle = element.getAttribute("style");
            if (!currentStyle) {
                currentStyle = ""
            }
            for (i = 0; i < styleArray.length; i++) {
                element.setAttribute("style", currentStyle + " " + styleArray[i] + ": " + styleArray[++i] + ";");
                currentStyle = element.getAttribute("style");
            };
        };

        // Adds style to all elements in an array
        function addStyleToArray(arrayOfElements, property, value) {
            for (let i = 0; i < arrayOfElements.length; i++) {
                addStyle(arrayOfElements[i], property, value);
            };
        };

        // Adds style to all elements of a class
        function addStyleByClass(cssClass, property, value) {
            let cssClassArray = document.getElementsByClassName(cssClass);

            addStyleToArray(cssClassArray, property, value);
        };

        function elmStyle(tag, parent, styleArray, id, cssClass) {
            var thisElm = elm(tag, parent, id, cssClass);
            addArrayOfStyles(thisElm, styleArray);
            return thisElm;
        };

        var body = document.body
    </script>
    <script>
        // An array of all the listings on the page
        var listings = document.getElementsByClassName("toyListing");
        // A locator for the container that holds the listings
        var listingsContainer = document.getElementById("listingsContainer");

        // this function adds a single listing to the page
        // the parameter snap is a snaphot of the database
        // the snap in this case actually only contains a snapshot of a SINGLE toy
        // this function is called by the filter function
        function createListing(snap) {

            // Create the html that will contain out listing and all it's information
            var thisListing = elm("div", listingsContainer, "", "toyListing ageOk priceOk searchOk");
            var title = elm("div", thisListing, "", "listingTitle");
            var price = elm("div", thisListing, "", "listingPrice");
            var ageRange = elm("div", thisListing, "", "listingAgeRange");

            // The key of the toy, used only as a back up if the name field is missing
            var thisToy = snap.key;
            // Grabbbing values from the snap
            var nameVal = snap.child("Name").val();
            var priceVal = snap.child("Price").val();
            var ageMaxVal = snap.child("Age_Max").val();
            var ageMinVal = snap.child("Age_Min").val();
            var picturePath = snap.child("Picture").val();

            // check that each value exists before adding it
            // if the value is null, display an error instead
            if (nameVal) {
                title.innerText = "Listing: " + nameVal
            } else {
                title.innerText = "Error: " + thisToy
            }

            if (priceVal || priceVal == 0) {
                price.innerText = "Price: $" + priceVal
            } else {
                price.innerText = "Error: no pricing data"
            }

            if (!!ageMinVal.toString() && !!ageMaxVal.toString()) {
                ageRange.innerHTML = "Age Range: " + ageMinVal + "-" + ageMaxVal;
            } else {
                ageRange.innerHTML = "Age range not available";
            }

            // create the picture for the listing
            var picture = $('<img/>', {
                class: 'listingPicture',
                alt: 'picture not available',
                //can get rid of .jpg if we add jpg to all files in database
                src: "Pictures/" + picturePath + '.jpg', 
            }).appendTo(thisListing);

            console.log(picturePath);

        };

        function initializeListings() {
            // this is the reference to our datadase, specifically the toys
            dbRef = firebase.database().ref().child("Toys");
            // this runs once whenever initializeListings is called and grabs the data from the database
            dbRef.once('value', function (snapshot) {
                listingsContainer.innerHTML = "";
                // a loop for each toy
                snapshot.forEach(function (snap) {
                    createListing(snap);
                });
            });
        };
        initializeListings();

        // unused right now because it called the database too often
        // this is the function that filters the page
        function filterPlus(minPrice, maxPrice, minAge, maxAge) {
            // this is the reference to our database, specifically the toys
            dbRef = firebase.database().ref().child("Toys");
            // this function runs every time the database has a change
            dbRef.on('value', function (snapshot) {
                // IMPORTANT: clear the old listings before adding updated ones 
                listingsContainer.innerHTML = "";
                // a loop for each toy
                snapshot.forEach(function (snap) {
                    // grabbing values from the database
                    priceVal = snap.child("Price").val();
                    ageMaxVal = snap.child("Age_Max").val();
                    ageMinVal = snap.child("Age_Min").val();
                    // the actual filters, if any of these pass, it means the filter failed, return ends the loop
                    if (priceVal < minPrice || priceVal > maxPrice) {
                        return;
                    }
                    if (maxAge < ageMinVal || minAge > ageMaxVal) {
                        return;
                    }
                    // Calls the create listing function with a single toys data. We only get to this point if both filters pass
                    createListing(snap);
                });
            });
        };
    </script>

    <script>
        // create the sliders
        jQuery(function ($) {
            $('.priceSlider').asRange({
                range: true,
                value: [0, 100],
                format(value) {
                    return "$" + value;
                }
            });
        });

        jQuery(function ($) {
            $('.ageSlider').asRange({
                range: true,
                value: [0, 20],
                format(value) {
                    return value;
                }
            });
        });
    </script>

    <script>
        // this script tag contains filters
        // slider filters
        $('.priceSlider').on('asRange::change', function (e) {
            var price = $('.priceSlider').asRange('val');
            $(".toyListing").filter(function () {
                var listingsPrice = $(this.getElementsByClassName("listingPrice")[0]).text().split(
                    ': $')[1];
                if (listingsPrice >= price[0] && listingsPrice <= price[1]) {
                    $(this).addClass("priceOk").removeClass("priceNo");
                } else {
                    $(this).removeClass("priceOk").addClass("priceNo");
                };
            });
            $(".ageOk.searchOk.priceNo").hide();
            $(".ageOk.searchOk.priceOk").show();
        });

        $('.ageSlider').on('asRange::change', function (e) {
            var age = $('.ageSlider').asRange('val');
            $(".toyListing").filter(function () {
                var listingsAgeRange = $(this.getElementsByClassName("listingAgeRange")[0]).text().split(
                    ': ')[1];
                var listingsMinAge = listingsAgeRange.split('-')[0];
                var listingsMaxAge = listingsAgeRange.split('-')[1];
                if (listingsMinAge <= age[1] && listingsMaxAge >= age[0]) {
                    $(this).addClass("ageOk").removeClass("ageNo");
                } else {
                    $(this).removeClass("ageOk").addClass("ageNo");
                };
            });
            $(".priceOk.searchOk.ageNo").hide();
            $(".priceOk.searchOk.ageOk").show();
        });
        // search bar
        $(document).ready(function () {
            $(".searchBar").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $(".priceOk.ageOk").filter(function () {
                    // $(this).toggle($(this.getElementsByClassName("listingTitle")[0]).text().split(': ')[1].toLowerCase().indexOf(value) > -1);
                    var listingTitle = $(this.getElementsByClassName("listingTitle")[0]).text().split(': ')[1];
                    
                    if (listingTitle.toLowerCase().indexOf(value) > -1) {
                        $(this).addClass("searchOk").removeClass("searchNo");
                    } else {
                        $(this).removeClass("searchOk").addClass("searchNo");
                    };
                });
                $(".ageOk.priceOk.searchNo").hide();
                $(".ageOk.priceOk.searchOk").show();
            });
        });
    </script>

    <script>
        // For testing offline only
        // If the browser is offline, creates test listings to help with development
        // This code should be removed before production, but theoretically it would never be shown unless firebase is down and our website is not
        if (!navigator.onLine) {
            for (i = 0; i < 5; i++) {
                var thisListing = elm("div", listingsContainer, "", "toyListing");
                var title = elm("div", thisListing, "", "listingTitle");
                title.innerHTML = "You are offline";
                var price = elm("div", thisListing, "", "listingPrice");
                price.innerHTML = "Price: cannot connect";
                var ageRange = elm("div", thisListing, "", "listingAgeRange");
                ageRange.innerHTML = "Age Range: to-firebase";
            }
        }
    </script>

</body>

</html>